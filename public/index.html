<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Панель авторизации</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #auth-page-content {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 28rem;
            margin: auto;
            animation: fadeIn 0.5s ease-in-out;
        }

        #auth-page-content h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #ffffff;
        }

        #auth-page-content input {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            color: #1f2937;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #auth-page-content input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        #auth-page-content button {
            background-color: #2563eb;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #auth-page-content button:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        #error-page-content {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 32rem;
            margin: auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease-in-out;
        }

        #error-page-content .error-code {
            font-size: 6rem;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        #error-page-content .error-message {
            font-size: 1.5rem;
            color: #ffffff;
        }

        #error-page-content .request-id,
        #error-page-content .info-text,
        #error-page-content .powered-by {
            color: #d1d5db;
        }

        #main-app-content {
            background-color: #f9fafb;
            padding: 2rem;
            border-radius: 1rem;
            margin: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #main-app-content .header-container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        #main-app-content button {
            background-color: #2563eb;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #main-app-content button:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }

        .user-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .user-card h3 {
            color: #1e3a8a;
            font-weight: 600;
        }

        .no-users-message {
            color: #6b7280;
            font-size: 1.25rem;
            background-color: #f3f4f6;
            padding: 2rem;
            border-radius: 0.75rem;
        }

        #full-screen-modal {
            background-color: rgba(0, 0, 0, 0.95);
            animation: fadeIn 0.3s ease-in-out;
        }

        #modal-header {
            background-color: rgba(0, 0, 0, 0.95);
            padding: 1rem;
            border-bottom: 1px solid #374151;
        }

        #modal-header button {
            background-color: #dc2626;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #modal-header button:hover {
            background-color: #b91c1c;
            transform: translateY(-2px);
        }

        .screenshot-item {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .screenshot-item:hover {
            transform: translateY(-3px);
        }

        .screenshot-item h3 {
            color: #1e3a8a;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }

        .screenshot-item img {
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .screenshot-item .answer-display {
            background-color: #eff6ff;
            border-left: 4px solid #2563eb;
            border-radius: 0.5rem;
            color: #1f2937;
        }

        .screenshot-item textarea {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .screenshot-item textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        .screenshot-item .submit-button {
            background-color: #22c55e;
        }

        .screenshot-item .submit-button:hover {
            background-color: #16a34a;
        }

        .screenshot-item .delete-button {
            background-color: #dc2626;
        }

        .screenshot-item .delete-button:hover {
            background-color: #b91c1c;
        }

        .screenshot-item .reset-button {
            background-color: #6b7280;
        }

        .screenshot-item .reset-button:hover {
            background-color: #4b5563;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            #auth-page-content {
                padding: 1.5rem;
                max-width: 90%;
            }

            #error-page-content {
                padding: 1.5rem;
                max-width: 90%;
            }

            #main-app-content {
                margin: 0.5rem;
                padding: 1rem;
            }

            .screenshot-item img {
                max-height: 250px;
            }

            .screenshot-item .action-buttons button {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div id="auth-page-container" class="hidden">
        <div id="auth-page-content">
            <h2 id="auth-title">Вход для администратора</h2>
            <form id="auth-form" class="flex flex-col gap-4 w-full">
                <input type="text" id="username" placeholder="Имя пользователя (например, admin1)" required class="p-3 rounded-lg">
                <input type="password" id="password" placeholder="Пароль (например, adminXA)" required class="p-3 rounded-lg">
                <button type="submit" id="auth-submit" class="p-3 rounded-lg font-semibold">Войти</button>
                <div class="error-message text-red-500 text-sm" id="auth-error"></div>
            </form>
        </div>
    </div>

    <div id="error-page-container" class="hidden">
        <div id="error-page-content">
            <div class="error-code">502</div>
            <div class="error-message">
                <a href="#" class="link invisible-link" id="bad-gateway-link">Bad</a> Gateway
            </div>
            <div class="request-id">Request ID: 95fb249e39e5c6d9-PDX</div>
            <div class="info-text">Этот сервис в настоящее время недоступен. Пожалуйста, попробуйте снова через несколько минут.</div>
            <div class="info-text">Если вы являетесь владельцем сайта, обратитесь к <a href="https://render.com/docs" class="link text-blue-400 hover:underline">документации Render</a> для устранения неполадок.</div>
            <div class="powered-by">Powered by Render</div>
        </div>
    </div>

    <div id="main-app-container" class="hidden">
        <div id="main-app-content">
            <div class="header-container">
                <h1 class="text-2xl font-bold text-gray-800">Админ-панель: Пользователи</h1>
                <button id="refresh-users" class="p-3 rounded-lg font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Обновить
                </button>
            </div>
            <div id="user-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <p class="no-users-message" id="no-users-message">Ожидание пользователей...</p>
            </div>
        </div>
    </div>

    <div id="full-screen-modal" class="hidden flex-col">
        <div id="modal-header" class="flex justify-between items-center">
            <button id="modal-close-button" class="p-3 rounded-lg font-semibold">Закрыть</button>
            <span id="screenshot-counter" class="text-white font-semibold"></span>
        </div>
        <div id="modal-screenshots-container" class="flex flex-col gap-6 w-full max-w-4xl mx-auto">
        </div>
    </div>

    <script>
        const authPageContainer = document.getElementById('auth-page-container');
        const errorPageContainer = document.getElementById('error-page-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const badGatewayLink = document.getElementById('bad-gateway-link');
        const pageTitle = document.getElementById('page-title');

        const userCardsContainer = document.getElementById('user-cards-container');
        let noUsersMessage = document.getElementById('no-users-message');
        const refreshUsersButton = document.getElementById('refresh-users');
        const fullScreenModal = document.getElementById('full-screen-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalScreenshotsContainer = document.getElementById('modal-screenshots-container');
        const screenshotCounter = document.getElementById('screenshot-counter');

        let ws;
        let authToken = null;
        let adminId = null;
        let currentOpenHelperId = null;
        const users = new Map(); // helperId -> { helperId, clientId, screenshots: [{ questionId, imageUrl, answer }], timestamp }

        function showPage(pageName) {
            authPageContainer.style.display = 'none';
            errorPageContainer.style.display = 'none';
            mainAppContainer.style.display = 'none';
            fullScreenModal.style.display = 'none';

            if (pageName === 'auth') {
                authPageContainer.style.display = 'flex';
                document.body.style.backgroundColor = '#000';
                document.body.style.color = '#fff';
                pageTitle.textContent = 'Вход для администратора';
            } else if (pageName === 'error') {
                errorPageContainer.style.display = 'flex';
                document.body.style.backgroundColor = '#000';
                document.body.style.color = '#fff';
                pageTitle.textContent = '502 Bad Gateway';
            } else if (pageName === 'main_app') {
                mainAppContainer.style.display = 'block';
                document.body.style.backgroundColor = '#f9fafb';
                document.body.style.color = '#333';
                pageTitle.textContent = 'Админ-панель: Пользователи';
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    initWebSocket();
                }
                checkNoUsers();
            }
        }

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = '';
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                authError.textContent = 'Требуются имя пользователя и пароль';
                return;
            }

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    showPage('main_app');
                } else {
                    authError.textContent = data.message || 'Ошибка входа. Проверьте имя пользователя и пароль.';
                }
            } catch (err) {
                authError.textContent = 'Ошибка сервера. Попробуйте позже.';
                console.error('Admin: Ошибка авторизации:', err);
            }
        });

        badGatewayLink.addEventListener('click', (event) => {
            event.preventDefault();
            showPage('auth');
        });

        function initWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Admin: WebSocket подключен');
                ws.send(JSON.stringify({ type: 'admin_connect', role: 'admin' }));
            };

            ws.onmessage = (event) => {
                let data;
                try {
                    data = JSON.parse(event.data);
                    console.log('Admin: Получено сообщение:', data);
                } catch (err) {
                    console.error('Admin: Ошибка разбора сообщения:', err);
                    return;
                }

                if (data.type === 'all_screenshots') {
                    users.clear();
                    data.screenshots.forEach(ss => {
                        let user = users.get(ss.helperId);
                        if (!user) {
                            user = {
                                helperId: ss.helperId,
                                clientId: ss.clientId,
                                screenshots: [],
                                timestamp: parseInt(ss.questionId.split('-')[1]) || Date.now()
                            };
                            users.set(ss.helperId, user);
                        }
                        user.screenshots.push({
                            questionId: ss.questionId,
                            imageUrl: ss.imageUrl,
                            answer: ss.answer
                        });
                    });
                    adminId = data.adminId;
                    renderUserCards();
                } else if (data.type === 'new_screenshot') {
                    let user = users.get(data.helperId);
                    if (!user) {
                        user = {
                            helperId: data.helperId,
                            clientId: data.clientId,
                            screenshots: [],
                            timestamp: parseInt(data.questionId.split('-')[1]) || Date.now()
                        };
                        users.set(data.helperId, user);
                    }
                    user.screenshots.push({
                        questionId: data.questionId,
                        imageUrl: data.imageUrl,
                        answer: ''
                    });
                    renderUserCards();
                } else if (data.type === 'update_screenshot') {
                    const user = Array.from(users.values()).find(u => u.screenshots.some(s => s.questionId === data.questionId));
                    if (user) {
                        const screenshot = user.screenshots.find(s => s.questionId === data.questionId);
                        if (screenshot) {
                            screenshot.answer = data.answer;
                            if (currentOpenHelperId === user.helperId) {
                                openScreenshotsModal(user.helperId);
                            }
                            renderUserCards();
                        }
                    }
                } else if (data.type === 'screenshot_deleted') {
                    const user = Array.from(users.values()).find(u => u.screenshots.some(s => s.questionId === data.questionId));
                    if (user) {
                        user.screenshots = user.screenshots.filter(s => s.questionId !== data.questionId);
                        if (user.screenshots.length === 0) {
                            users.delete(user.helperId);
                        }
                        renderUserCards();
                        if (currentOpenHelperId === user.helperId) {
                            if (user.screenshots.length > 0) {
                                openScreenshotsModal(user.helperId);
                            } else {
                                closeScreenshotsModal();
                            }
                        }
                    }
                } else if (data.type === 'helper_deleted') {
                    users.delete(data.helperId);
                    renderUserCards();
                    if (currentOpenHelperId === data.helperId) {
                        closeScreenshotsModal();
                    }
                } else if (data.type === 'error') {
                    console.error('Admin: Ошибка сервера:', data.message);
                    alert(data.message);
                }
            };

            ws.onclose = () => {
                console.log('Admin: WebSocket отключен. Переподключение через 2 секунды...');
                setTimeout(initWebSocket, 2000);
            };

            ws.onerror = (error) => {
                console.error('Admin: Ошибка WebSocket:', error);
                showPage('error');
            };
        }

        function renderUserCards() {
            userCardsContainer.innerHTML = '';
            const sortedUsers = Array.from(users.values()).sort((a, b) => b.timestamp - a.timestamp);
            if (sortedUsers.length === 0) {
                if (!noUsersMessage) {
                    noUsersMessage = document.createElement('p');
                    noUsersMessage.className = 'no-users-message';
                    noUsersMessage.id = 'no-users-message';
                    userCardsContainer.appendChild(noUsersMessage);
                }
                noUsersMessage.style.display = 'block';
                noUsersMessage.textContent = 'Ожидание пользователей...';
            } else {
                sortedUsers.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.dataset.helperId = user.helperId;
                    card.addEventListener('click', () => openScreenshotsModal(user.helperId));

                    const h3 = document.createElement('h3');
                    h3.textContent = `Пользователь: ${user.helperId}`;
                    card.appendChild(h3);

                    const countDiv = document.createElement('div');
                    countDiv.className = 'screenshot-count';
                    countDiv.textContent = `Скриншотов: ${user.screenshots.length}`;
                    card.appendChild(countDiv);

                    userCardsContainer.appendChild(card);
                });
                if (noUsersMessage) {
                    noUsersMessage.style.display = 'none';
                }
            }
        }

        function checkNoUsers() {
            if (users.size === 0) {
                if (!noUsersMessage) {
                    noUsersMessage = document.createElement('p');
                    noUsersMessage.className = 'no-users-message';
                    noUsersMessage.id = 'no-users-message';
                    userCardsContainer.appendChild(noUsersMessage);
                }
                noUsersMessage.style.display = 'block';
                noUsersMessage.textContent = 'Ожидание пользователей...';
            } else {
                if (noUsersMessage) {
                    noUsersMessage.style.display = 'none';
                }
            }
        }

        function openScreenshotsModal(helperId) {
            currentOpenHelperId = helperId;
            const user = users.get(helperId);
            modalScreenshotsContainer.innerHTML = '';

            if (!user || user.screenshots.length === 0) {
                modalScreenshotsContainer.innerHTML = '<p class="no-screenshots-for-user">Для этого пользователя пока нет скриншотов.</p>';
                screenshotCounter.textContent = '';
            } else {
                user.screenshots.sort((a, b) => {
                    const timeA = parseInt(a.questionId.split('-')[1]) || 0;
                    const timeB = parseInt(b.questionId.split('-')[1]) || 0;
                    return timeB - timeA;
                }).forEach(ss => {
                    const screenshotItem = document.createElement('div');
                    screenshotItem.className = 'screenshot-item';
                    screenshotItem.dataset.questionId = ss.questionId;

                    const h3 = document.createElement('h3');
                    const filename = ss.questionId.split('/').pop();
                    const parts = filename.split('-');
                    const screenshotNumber = parts[parts.length - 1].replace('.png', '');
                    h3.textContent = `Скриншот: ${screenshotNumber} (ClientId: ${user.clientId})`;
                    screenshotItem.appendChild(h3);

                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'image-wrapper';
                    screenshotItem.appendChild(imageWrapper);

                    const img = document.createElement('img');
                    img.src = ss.imageUrl;
                    img.alt = `Скриншот ${ss.questionId}`;
                    img.onerror = () => console.error(`Admin: Ошибка загрузки изображения: ${ss.imageUrl}`);
                    img.onload = () => console.log(`Admin: Изображение загружено: ${ss.imageUrl}`);
                    imageWrapper.appendChild(img);

                    const answerDisplay = document.createElement('div');
                    answerDisplay.className = 'answer-display';
                    answerDisplay.textContent = ss.answer ? `Ответ: ${ss.answer}` : 'Ожидание ответа...';
                    screenshotItem.appendChild(answerDisplay);

                    const textarea = document.createElement('textarea');
                    textarea.placeholder = 'Введите ответ...';
                    textarea.value = ss.answer || '';
                    screenshotItem.appendChild(textarea);

                    const actionButtonsDiv = document.createElement('div');
                    actionButtonsDiv.className = 'action-buttons';
                    screenshotItem.appendChild(actionButtonsDiv);

                    const submitButton = document.createElement('button');
                    submitButton.textContent = 'Отправить ответ';
                    submitButton.className = 'submit-button';
                    submitButton.onclick = () => sendAnswer(ss.questionId, textarea.value, user.clientId);
                    actionButtonsDiv.appendChild(submitButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Удалить';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => deleteScreenshot(ss.questionId);
                    actionButtonsDiv.appendChild(deleteButton);

                    const resetButton = document.createElement('button');
                    resetButton.textContent = 'Сбросить ответ';
                    resetButton.className = 'reset-button';
                    resetButton.onclick = () => resetAnswer(ss.questionId, textarea, user.clientId);
                    actionButtonsDiv.appendChild(resetButton);

                    modalScreenshotsContainer.appendChild(screenshotItem);
                });

                screenshotCounter.textContent = `Скриншотов: ${user.screenshots.length}`;
            }
            fullScreenModal.style.display = 'flex';
        }

        function closeScreenshotsModal() {
            fullScreenModal.style.display = 'none';
            currentOpenHelperId = null;
            modalScreenshotsContainer.innerHTML = '';
        }

        modalCloseButton.addEventListener('click', closeScreenshotsModal);

        function sendAnswer(questionId, answer, clientId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'submit_answer',
                    questionId,
                    answer,
                    adminId,
                    clientId
                }));
                console.log(`Admin: Отправлен ответ для questionId: ${questionId}, clientId: ${clientId}, adminId: ${adminId}`);
            } else {
                console.error('Admin: WebSocket не подключен. Невозможно отправить ответ.');
                showPage('error');
            }
        }

        function deleteScreenshot(questionId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                if (confirm('Вы уверены, что хотите удалить этот скриншот? Это действие безвозвратно удалит его с сервера!')) {
                    ws.send(JSON.stringify({
                        type: 'delete_screenshot',
                        questionId,
                        adminId
                    }));
                    console.log(`Admin: Отправлен запрос на удаление скриншота ${questionId}, adminId: ${adminId}`);
                }
            } else {
                console.error('Admin: WebSocket не подключен. Невозможно отправить запрос на удаление.');
                showPage('error');
            }
        }

        function resetAnswer(questionId, textarea, clientId) {
            textarea.value = '';
            sendAnswer(questionId, '', clientId);
            console.log(`Admin: Ответ для ${questionId} сброшен, clientId: ${clientId}, adminId: ${adminId}`);
        }

        function refreshUsers() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'request_all_screenshots',
                    role: 'admin',
                    adminId
                }));
                console.log(`Admin: Запрошены все скриншоты, adminId: ${adminId}`);
            } else {
                console.error('Admin: WebSocket не подключен. Невозможно запросить скриншоты.');
                showPage('error');
            }
        }

        refreshUsersButton.addEventListener('click', refreshUsers);

        document.addEventListener('DOMContentLoaded', () => {
            showPage('auth');
        });
    </script>
</body>
</html>
