<!DOCTYPE html>
<html>
<head>
    <title>КОМНАТЫ ТЕСТОВ</title>
    <meta charset="utf-8">
    <style>
        body { margin:0; font-family:Arial; background:#000; color:#0f0; }
        .room { background:#111; margin:15px; padding:15px; border:2px solid #0f0; border-radius:10px; cursor:pointer; }
        .room:hover { background:#003300; }
        .active { border-color:#00ff00 !important; box-shadow:0 0 20px #0f0; }
        .question { margin:20px 0; padding:15px; background:#001100; border-radius:8px; }
        .options { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
        .opt { padding:10px; background:#002200; text-align:center; cursor:pointer; border:2px solid #0f0; border-radius:8px; }
        .opt.correct { background:#004400; border-color:#00ff00; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
    </style>
</head>
<body>
    <h1 style="text-align:center;color:#0f0">ЖИВЫЕ КОМНАТЫ</h1>
    <div id="rooms"></div>

    <div id="test-view" style="display:none;margin:20px;color:#0f0">
        <button onclick="back()">Назад</button>
        <h2 id="room-title"></h2>
        <div id="questions"></div>
    </div>

<script>
    const ws = new WebSocket((location.protocol==='https:'?'wss':'ws') + '://' + location.host);
    let currentRoom = null;

    ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.type === "rooms_update") {
            renderRooms(d.rooms);
        }
        if (d.type === "full_rooms_data" && currentRoom) {
            renderTest(d.rooms[currentRoom]);
        }
    };

    function renderRooms(list) {
        const el = document.getElementById('rooms');
        el.innerHTML = list.sort((a,b)=>b.timestamp-a.timestamp).map(r => `
            <div class="room" onclick="openRoom('${r.sessionId}')">
                <b>Комната ${r.sessionId.slice(-8)}</b><br>
                Вопросов: ${r.total} | Отвечено: ${r.answered}
            </div>
        `).join('');
    }

    function openRoom(id) {
        currentRoom = id;
        document.getElementById('rooms').style.display = 'none';
        document.getElementById('test-view').style.display = 'block';
        document.getElementById('room-title').textContent = "Комната " + id.slice(-8);
        ws.send(JSON.stringify({type:"request_room", sessionId: id}));
    }

    function renderTest(room) {
        const q = document.getElementById('questions');
        q.innerHTML = room.tests.map((t, i) => `
            <div class="question">
                <b>Вопрос ${i+1}</b>
                <img src="${t.questionImage}" style="max-width:100%;border:1px solid #0f0;margin:10px 0">
                <div class="options">
                    ${t.options.map(o => `
                        <div class="opt ${room.answers[i+1]===o.letter?'correct':''}"
                             onclick="selectAnswer(${i+1},'${o.letter}')">
                            <b>${o.letter}</b>
                            <img src="${o.image}" style="max-width:100%;margin-top:5px">
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function selectAnswer(qIndex, letter) {
        ws.send(JSON.stringify({
            type: "answer_selected",
            sessionId: currentRoom,
            questionIndex: qIndex,
            letter
        }));
    }

    function back() {
        document.getElementById('test-view').style.display = 'none';
        document.getElementById('rooms').style.display = 'block';
        currentRoom = null;
    }

    ws.onopen = () => ws.send(JSON.stringify({type:"admin_connect"}));
</script>
</body>
</html>
